<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.boot.dao.TeamDAO">

	<!-- 회원가입 -->
	<insert id="recruit" useGeneratedKeys="true" keyProperty="mf_no" keyColumn="mf_no">
		INSERT INTO matflix (
	  		mf_id, mf_pw, mf_pw_chk, mf_nickname,
	 		mf_name, mf_email, mf_phone, mf_birth, mf_gender
		) VALUES (
			#{mf_id}, #{mf_pw}, #{mf_pw_chk}, #{mf_name},
			#{mf_name}, #{mf_email}, #{mf_phone}, #{mf_birth}, #{mf_gender}
		)
	</insert>

	<!-- 프로필 이미지 생성 -->
	<insert id="recruit_profile_image">
		INSERT INTO user_image (mf_no, profile_image_path) VALUES (#{mf_no}, NULL)
	</insert>

	<!-- 프로필 이미지 수정 -->
	<update id="modify_profile_image">
		UPDATE user_image
		   SET profile_image_path = #{profile_image_path}
		 WHERE mf_no =#{mf_no}
	</update>

	<!-- 로그인 -->
	<select id="login" resultType="int">
		SELECT COUNT(*) FROM matflix
		<where>
			<if test="mf_id != null and mf_id != ''">
				AND mf_id = #{mf_id}
			</if>
			<if test="mf_pw != null and mf_pw != ''">
				AND mf_pw = #{mf_pw}
			</if>
		</where>
	</select>

	<!-- 회원 리스트 -->
	<select id="list" resultType="com.boot.dto.TeamDTO">
		select mf_no, mf_id, mf_pw,
		mf_pw_chk, mf_name, mf_nickname, mf_email,
		mf_phone, mf_birth, mf_gender from
		matflix
	</select>
	
	<!-- id로 회원 찾기 -->
	<select id="find_list" resultType="com.boot.dto.TeamDTO">
<!--		select mf_no, mf_id, mf_pw, mf_pw_chk, mf_nickname, mf_name, mf_email,-->
<!--		mf_phone, mf_birth, mf_gender, mf_regdate, mf_role from matflix where mf_id=#{mf_id}-->
		SELECT m.mf_no
		  	 , m.mf_id
		  	 , m.mf_nickname
		  	 , m.mf_name
		  	 , m.mf_email
		 	 , m.mf_phone
		 	 , m.mf_birth
		  	 , m.mf_gender
		  	 , m.mf_regdate
		  	 , m.mf_role
		  	 , m.mf_nickname_updatetime
		  	 , ui.profile_image_path
		  FROM matflix m
		  LEFT JOIN user_image ui
	        ON ui.mf_no = m.mf_no
		 WHERE m.mf_id = #{mf_id}
	</select>
	
	<!-- 내 프로필 -->
	<select id="profile" resultType="com.boot.dto.ProfileDTO">
		SELECT m.mf_no
		  	 , m.mf_id
		  	 , m.mf_nickname
		  	 , m.mf_name
		  	 , m.mf_email
		 	 , m.mf_phone
		 	 , m.mf_birth
		  	 , m.mf_gender
		  	 , m.mf_regdate
		  	 , m.mf_role
		  	 , m.mf_nickname_updatetime
		  	 , ui.profile_image_path
		  	 , (SELECT COUNT(*)
		      	  FROM follow f
		     	 WHERE f.following_id = m.mf_no) AS follower_count
		  	 , (SELECT COUNT(*)
		      	  FROM follow f
		         WHERE f.follower_id = m.mf_no) AS following_count
		  	 , (SELECT COUNT(*)
		       	  FROM recipe r
		      	 WHERE r.mf_no = m.mf_no) AS recipe_count
		  FROM matflix m
		  LEFT JOIN user_image ui
	        ON ui.mf_no = m.mf_no
		 WHERE m.mf_no = #{mf_no}
	</select>

	<!-- 개인 정보 수정 -->
	<update id="update_ok" parameterType="hashmap">
	    UPDATE matflix
	       SET mf_pw = #{mf_pw}
	         , mf_pw_chk = #{mf_pw_chk}
	         , mf_name = #{mf_name}
	         , mf_email = #{mf_email}
	     WHERE mf_id = #{mf_id}
	</update>
	
	<!-- 유저 정보 삭제 -->
	<delete id="delete_ok">
		delete from matflix where mf_no=#{mf_no}
	</delete>
	
	<!-- 닉네임 변경 일시 -->
	<select id="nickname_updatetime_check" resultType="java.time.LocalDateTime">
		select mf_nickname_updatetime
		  from matflix
		 where mf_no = #{mf_no}
	</select>
	
	<!-- 닉네임 변경 일시 업데이트 -->
	<update id="nickname_updatetime_update">
		update matflix
		   set mf_nickname_updatetime = NOW()
		 where mf_no = #{mf_no}
	</update>
	
	<!-- 닉네임 중복 확인 -->
	<select id="nickname_check" resultType="int">
		select count(*)
		  from matflix
		 where mf_nickname = #{mf_nickname}
	</select>
	
	<!-- 닉네임 변경 -->
	<update id="nickname">
		update matflix set mf_nickname=#{mf_nickname}
		<where>
			mf_id = #{mf_id}
		</where>
	</update>

	<!-- 유저 고유 번호로 정보 찾기 -->
	<select id="find_user_by_no" resultType="com.boot.dto.TeamDTO">
		select mf_no, mf_id, mf_pw, mf_pw_chk, mf_name, mf_nickname, mf_email, mf_phone, mf_birth, mf_gender, mf_regdate, mf_role from matflix where mf_no = #{mf_no}
	</select>

	<!-- 랭킹에 있는 유저 정보 가져오기 -->
	<select id="rank_user" resultType="map">
		select mf_no
			 , mf_nickname
			 , mf_email
			 , mf_gender
			 , mf_regdate
		  from matflix
		 where mf_no=#{mf_no}
	</select>

	<!-- pw -->
	<select id="pw_check" resultType="String">
		select mf_pw
		  from matflix
		 where mf_no=#{mf_no}
	</select>
	
</mapper>