<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.NotificationDAO">

	<!-- 알림 추가 -->
	<insert id="add_notification">
		INSERT INTO notifications (receiver_id, sender_id, notif_type, target_type, target_id)
		VALUES (#{receiver_id},#{sender_id},#{notif_type},#{target_type},#{target_id})
	</insert>

	<!-- 알림 보기 -->
    <select id="notification_list" resultType="com.boot.dto.NotificationDTO">
    	select *
    	  from notifications
    	 where receiver_id = #{receiver_id}
    	 ORDER BY notifications_id DESC
    </select>

	<!-- 안 읽은 알림 보기 -->
    <select id="notification_list_n" resultType="com.boot.dto.NotificationDTO">
    	select n.notif_id
    		 , n.receiver_id
    		 , n.sender_id
    		 , n.notif_type
    		 , n.target_type
    		 , n.target_id
    		 , n.is_read
    		 , n.created_at
    		 , m.mf_nickname as mf_nickname
    	  from notifications n
    	  join matflix m
    	    on n.sender_id = m.mf_no
    	 where receiver_id = #{receiver_id}
    	   and is_read = 0
    	 ORDER BY created_at DESC
    </select>
    
    <!-- 알림 읽음 처리 -->
    <update id="is_read_true">
    	update notifications
    	   set is_read = 1
    	 where notif_id=#{notif_id}
    </update>
    
    <!-- 알림 갯수 카운트 -->
    <select id="notification_count" resultType="int">
    	select count(*)
    	  from notifications
    	 where receiver_id = #{receiver_id}
    	   and is_read = 0
    </select>
    
    <!-- 알림 삭제 -->
	<delete id="delete_notification">
		DELETE n
		  FROM notifications n
		  JOIN (
		       SELECT notif_id
		         FROM notifications
		        WHERE sender_id = #{sender_id}
				   OR receiver_id = #{receiver_id}
			   ) t ON n.notif_id = t.notif_id;
	</delete>
</mapper>