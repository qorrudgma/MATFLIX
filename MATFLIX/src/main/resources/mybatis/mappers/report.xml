<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.ReportDAO">

	<sql id="report_search">
	    <if test="status != null and status != ''">
	        AND r.status = #{status}
	    </if>
	
	    <if test="target_type != null and target_type != ''">
	        AND r.target_type = #{target_type}
	    </if>
	
	    <if test="report_reason != null and report_reason != ''">
	        AND r.report_reason = #{report_reason}
	    </if>
	
	    <!-- 신고 많이 받은 사람(대상 작성자) 기준 -->
	    <if test="target_owner_mf_no != null">
	        AND r.target_owner_mf_no = #{target_owner_mf_no}
	    </if>
	
	    <!-- 신고자(id/닉네임) 검색 -->
	    <if test="reporter_keyword != null and reporter_keyword != ''">
	        AND (
	                m.mf_id LIKE CONCAT('%', #{reporter_keyword}, '%')
	             OR m.mf_nickname LIKE CONCAT('%', #{reporter_keyword}, '%')
	        )
	    </if>
	
	    <!-- 제목/상세 키워드 -->
	    <if test="keyword != null and keyword != ''">
	        AND (
	                r.report_title LIKE CONCAT('%', #{keyword}, '%')
	             OR r.report_detail LIKE CONCAT('%', #{keyword}, '%')
	        )
	    </if>
	
	    <!-- 기간 -->
	    <if test="date_from != null">
	        AND r.created_at <![CDATA[ >= ]]> #{date_from}
	    </if>
	    <if test="date_to != null">
	        AND r.created_at <![CDATA[ <= ]]> #{date_to}
	    </if>
	</sql>

	
    <!-- 신고 추가 -->
    <insert id="insert_report" parameterType="com.boot.dto.ReportDTO">
		INSERT INTO report (
			reporter_mf_no,
			target_type,
			target_id,
			target_owner_mf_no,
			report_title,
			report_reason,
			report_detail
		) VALUE (
	        #{reporter_mf_no},
	        #{target_type},
	        #{target_id},
	        #{target_owner_mf_no},
	        #{report_title},
	        #{report_reason},
	        #{report_detail}
		)
    </insert>
	
    <!-- 신고 내역 -->
    <select id="report_list" resultType="com.boot.dto.ReportDTO">
		SELECT r.report_id
		     , r.report_title
		     , r.report_reason
		     , r.status
		     , r.target_type
		     , r.target_id
		     , r.created_at
		     , m.mf_no        AS reporter_mf_no
		     , m.mf_id        AS reporter_mf_id
		     , m.mf_nickname  AS reporter_mf_nickname
		FROM report r
		JOIN matflix m
		  ON r.reporter_mf_no = m.mf_no
		ORDER BY r.report_id DESC
		LIMIT #{pageSize} OFFSET #{offset}
    </select>
    
</mapper>