<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.RecipeDAO">

	<!-- 레시피 등록 -->
	<insert id="insert_recipe" parameterType="com.boot.dto.RecipeDTO" useGeneratedKeys="true" keyProperty="recipe_id">
		INSERT INTO recipe (mf_no, title, intro, servings, cook_time, difficulty, category, tip
				) VALUES (#{mf_no}, #{title}, #{intro}, #{servings}, #{cook_time}, #{difficulty}, #{category}, #{tip})
	</insert>

	<!-- 재료 insert -->
	<insert id="insert_recipe_ingredient" parameterType="com.boot.dto.RecipeIngredientDTO" useGeneratedKeys="true" keyProperty="ingredient_id">
        INSERT INTO recipe_ingredient (recipe_id, ingredient_name, ingredient_amount )
        						VALUES (#{recipe_id}, #{ingredient_name}, #{ingredient_amount})
	</insert>
	
	<!-- 순서 insert -->
	<insert id="insert_recipe_step" parameterType="com.boot.dto.RecipeStepDTO" useGeneratedKeys="true" keyProperty="step_id">
        INSERT INTO recipe_step (recipe_id, step_no, step_content )
						VALUES (#{recipe_id}, #{step_no}, #{step_content})
	</insert>
	
	<!-- 태그 insert -->
	<insert id="insert_recipe_tag" parameterType="com.boot.dto.RecipeTagDTO" useGeneratedKeys="true" keyProperty="tag_id">
        INSERT INTO recipe_tag (recipe_id, tag)
						VALUES (#{recipe_id}, #{tag})
	</insert>
	
	<!-- 이미지 insert -->
	<insert id="insert_recipe_image" parameterType="com.boot.dto.RecipeImageDTO" useGeneratedKeys="true" keyProperty="image_id">
        INSERT INTO recipe_image (recipe_id, image_type, step_no, image_path)
        						VALUES (#{recipe_id}, #{image_type}, #{step_no}, #{image_path})
	</insert>
	
	<!-- 리뷰 insert -->
	<insert id="insert_recipe_review" parameterType="com.boot.dto.RecipeReviewDTO" useGeneratedKeys="true" keyProperty="review_id">
        INSERT INTO recipe_review (recipe_id, mf_no, rating, content, rating)
        						VALUES (#{recipe_id}, #{mf_no}, #{rating}, #{content}, #{rating})
	</insert>
	
	<!-- 레시피 삭제 -->	
	<delete id="delete_recipe" parameterType="int">
		DELETE FROM recipe
		 WHERE recipe_id = #{recipe_id}
	</delete>

	<!-- 레시피 리스트 -->	
	<select id="recipe_list" resultType="com.boot.dto.RecipeDTO">
		SELECT r.recipe_id, r.mf_no, r.title, r.intro, r.servings, r.cook_time, r.difficulty, r.category, r.tip, r.star, r.updated_at, m.mf_nickname, ri.image_path
		  FROM recipe r
		  JOIN matflix m
			ON r.mf_no = m.mf_no
		  LEFT JOIN recipe_image ri
		    ON r.recipe_id = ri.recipe_id
		   AND ri.image_type ="THUMBNAIL"
		 ORDER BY r.updated_at DESC
	</select>

	<!-- 마이 레시피 리스트 -->	
	<select id="my_recipe_list" resultType="com.boot.dto.RecipeDTO">
		SELECT r.recipe_id, r.mf_no, r.title, r.intro, r.servings, r.cook_time, r.difficulty, r.category, r.tip, r.star, r.updated_at, m.mf_nickname, ri.image_path
		  FROM recipe r
		  JOIN matflix m
			ON r.mf_no = m.mf_no
		  LEFT JOIN recipe_image ri
		    ON r.recipe_id = ri.recipe_id
		   AND ri.image_type ="THUMBNAIL"
		 WHERE r.mf_no = #{mf_no}
		 ORDER BY r.updated_at DESC
	</select>

	<!-- 레시피 -->	
	<select id="recipe" resultType="com.boot.dto.RecipeDTO">
		SELECT r.recipe_id, r.mf_no, r.title, r.intro, r.servings, r.cook_time, r.difficulty, r.category, r.tip, r.star, r.recommend, r.updated_at, m.mf_nickname, ri.image_path
		  FROM recipe r
		  JOIN matflix m
			ON r.mf_no = m.mf_no
		  LEFT JOIN recipe_image ri
		    ON r.recipe_id = ri.recipe_id
		   AND ri.image_type ="THUMBNAIL"
		 WHERE r.recipe_id = #{recipe_id}
	</select>

	<!-- 재료 -->	
	<select id="recipe_ingredient" resultType="com.boot.dto.RecipeIngredientDTO">
		SELECT *
		  FROM recipe_ingredient
		 WHERE recipe_id = #{recipe_id}
	</select>

	<!-- 순서 -->	
	<select id="recipe_step" resultType="com.boot.dto.RecipeStepDTO">
		SELECT *
		  FROM recipe_step
		 WHERE recipe_id = #{recipe_id}
	</select>

	<!-- 이미지 -->	
	<select id="recipe_image" resultType="com.boot.dto.RecipeImageDTO">
		SELECT *
		  FROM recipe_image
		 WHERE recipe_id = #{recipe_id}
	</select>

	<!-- 태그 -->	
	<select id="recipe_tag" resultType="com.boot.dto.RecipeTagDTO">
		SELECT *
		  FROM recipe_tag
		 WHERE recipe_id = #{recipe_id}
	</select>

	<!-- 추천 수 -->	
	<select id="recipe_recommend_count" resultType="int">
		SELECT recommend
		  FROM recipe
		 WHERE recipe_id = #{recipe_id}
	</select>

	<!-- ========================================== -->

	<!-- 과정 insert -->
	<insert id="insert_rc_course" parameterType="java.util.List">
	        INSERT INTO rc_course (
	        	rc_recipe_id,
	            rc_course_description
	        )
	        VALUES (
	        	(SELECT MAX(rc_recipe_id) FROM Recipe),
	            #{rc_course_description}
	        )
	</insert>

<!--각 카테고리 별 레시피 아이디 추출-->
	<select id="get_food">
		select rc_recipe_id from recipe_r where rc_category1_id = #{rc_category1_id}
	</select>
	
	<select id="find_list_all" resultType="com.boot.dto.RecipeDTO">
		select rc_recipe_id, rc_name, rc_description, rc_category1_id, rc_category2_id, rc_cooking_time, rc_difficulty, rc_created_at, rc_img, rc_tip, rc_tag, mf_no, star_score from recipe_r
	</select>
	
	<select id="get_recipe_by_id">
		select rc_recipe_id, rc_name, rc_description, rc_category1_id, rc_category2_id, rc_cooking_time, rc_difficulty, rc_created_at, rc_img, rc_tip, rc_tag, mf_no, star_score from recipe_r where rc_recipe_id=#{rc_recipe_id}
	</select>
	<select id="get_recipe_ingredient_by_id" resultType="com.boot.dto.RcIngredientDTO">
		select rc_recipe_id, rc_ingredient_id, rc_ingredient_name, rc_ingredient_amount from rc_ingredient where rc_recipe_id = #{rc_recipe_id}
	</select>
	<select id="get_recipe_course_by_id" resultType="com.boot.dto.RcCourseDTO">
		select rc_recipe_id, rc_recipe_id, rc_course_description, rc_course_img from rc_course where rc_recipe_id = #{rc_recipe_id}
	</select>

<!--	페이징처리-->
	<select id="paging_recipe_list" resultType="com.boot.dto.RecipeDTO">
		select rc_recipe_id, rc_name, rc_description, rc_category1_id, rc_category2_id, rc_cooking_time, rc_difficulty, rc_created_at, rc_img, rc_tip, rc_tag, mf_no, star_score from recipe_r where rc_recipe_id=#{rc_recipe_id}
	</select>
	
<!--	마이페이지 내 레시피-->
	<select id="get_recipe_by_user_id" resultType="com.boot.dto.RecipeDTO">
		select rc_recipe_id, rc_name, rc_description, rc_category1_id, rc_category2_id, rc_cooking_time, rc_difficulty, rc_created_at, rc_img, rc_tip, rc_tag, mf_no, star_score from recipe_r where mf_no = #{mf_no}
	</select>
	
<!--	레시피 아이디로 멤버 넘버 출력-->
	<select id="get_mf_no_by_id" resultType="int">
		select mf_no from recipe_r where rc_recipe_id = #{rc_recipe_id}
	</select>
	
<!--	별점 추가-->
	<update id="update_star_score">
		UPDATE recipe_r
		SET star_score = #{star_score}
		WHERE rc_recipe_id = #{rc_recipe_id}
	</update>
	
	<!-- 레시피 카운트 -->
	<select id="my_recipe_count" resultType="int">
		select count(*)
		  from recipe_r
		 where mf_no = #{mf_no}
	</select>
	
</mapper>