<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.RecipeCommentDAO">
    
    <!-- 댓글 작성 -->
    <insert id="insert_recipe_comment">
		insert into recipe_comment(recipe_id
			 , mf_no 	
			 , comment_content
			 , parentCommentNo)
		values(#{recipe_id},#{mf_no},#{comment_content},#{parentCommentNo})
    </insert>
    
    <!-- 댓글 리스트 -->
    <select id="all_recipe_comment" resultType="com.boot.dto.RecipeCommentDTO">
		SELECT rc.comment_no
		     , rc.recipe_id
		     , rc.mf_no
		     , rc.comment_content
		     , rc.parentCommentNo
		     , rc.deleted
		     , rc.created_at
		     , rc.recommend_count
		     , m.mf_nickname
		     , ui.profile_image_path AS profile_image_path
	        <!-- 로그인 -->
	        <if test="mf_no != 0">
	            , (select count(*) from recipe_comment_recommend rcr where rcr.mf_no = #{mf_no} and comment_no = rc.comment_no) AS recommended
	        </if>
    	  FROM recipe_comment rc
		  LEFT JOIN user_image ui
			ON rc.mf_no = ui.mf_no
          JOIN matflix m
            ON rc.mf_no = m.mf_no
         WHERE rc.recipe_id = #{recipe_id}
           AND rc.deleted = 0
         ORDER BY rc.comment_no ASC
    </select>

	<!-- 댓글 수정 -->
    <update id="recipe_comment_modify">
    	update recipe_comment set comment_content = #{comment_content} where comment_no=#{comment_no} and mf_no = #{mf_no}
    </update>

	<!-- 댓글 삭제 -->
    <update id="recipe_comment_delete">
    	update recipe_comment set deleted = 1 where comment_no=#{comment_no}
    </update>

	<!-- 댓글 추천 추가 -->
    <update id="add_recipe_comment_recommend">
    	update recipe_comment set recommend_count = recommend_count + 1 where comment_no=#{comment_no}
    </update>

	<!-- 댓글 추천 삭제 -->
    <update id="minus_recipe_comment_recommend">
    	update recipe_comment set recommend_count = recommend_count - 1 where comment_no=#{comment_no}
    </update>
</mapper>